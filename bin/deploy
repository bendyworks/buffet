#!/usr/bin/env bash

set -u
echo '-- serving Bendyworks buffet...'

# DOTFILE LINKING =============================================================

# absolute path to the Buffet directory
rel_path="$(dirname "$0")"

cd "$rel_path/.."

export BUFFET_DIRECTORY="$(pwd)"

# link every dotfile in dotfiles/, into the user's home directory
# if a dotfile exists with that name, add the ".unused" extension
# for dotfile in $BUFFET_DIRECTORY/dotfiles/*; do
#   original="$HOME/.${dotfile##*/}"
#   [ ! -h "$original" ] && mv "$original" "$original.unused" 2> /dev/null
#   ln -fs "$dotfile" "$original"
# done

function contains() {
  local n=$#
  local value=${!n}
  for ((i=1;i < $#;i++)) {
    if [ "${!i}" == "${value}" ]; then
      echo "y"
      return 0
    fi
  }
  echo "n"
  return 1
}

IGNORE_FILES=("." ".." ".git")

for sourcefile in $BUFFET_DIRECTORY/dotfiles/{.*,*}; do
  echo "Processing $sourcefile"

  filename="${sourcefile##*/}"
  echo "$filename"

  if [ $(contains "${IGNORE_FILES[@]}" "$filename") == "y" ]; then
    continue;
  fi

  targetfile="$HOME/.$filename"
  echo "$targetfile"
  echo

  [ ! -h "$targetfile" ] && mv "$targetfile" "$targetfile.unused" 2> /dev/null
  ln -fs "$sourcefile" "$targetfile"
done

# VIM SETUP ===================================================================

# set backup directories so that .swp files don't litter the workspace
vim_dir="$HOME/.vim"
mkdir -p "$vim_dir/backup"
mkdir -p "$vim_dir/swp"
mkdir -p "$vim_dir/undo"

# install vundle to ease installing Vim plugins
vundle_dir="$vim_dir/bundle"
vundle_path="$vundle_dir/Vundle.vim"
vundle_repo='https://github.com/VundleVim/Vundle.vim.git'

mkdir -p "$vundle_dir"
if [ ! -d "$vundle_path" ]; then
  echo '-- installing Vim plugins...'
  git clone "$vundle_repo" "$vundle_path"
  vim +PluginInstall +qall
fi


# TODO: these take a long time. maybe it'd be better to only install a core set?
if hash apm 2>/dev/null; then
  read -t 3 -p "Install Atom Plugins (Y/n)? " answer
  [ -z "$answer" ] && answer="Y"
  echo
  if [ "$answer" != "${answer#[Yy]}" ] ;then
    echo '-- install Atom plugins...'
    apm install linter script vim-mode-plus vim-surround atom-pair \
      language-gherkin language-haml Sublime-Style-Column-Selection atom-typescript autocomplete-ruby \
      highlight-selected language-rspec linter linter-js-yaml linter-rubocop markdown-scroll-sync \
      merge-conflicts rails-rspec rails-transporter ruby-test toggle-quotes vim-mode-plus \
      Sublime-Style-Column-Selection atom-beautify atom-bootstrap3 atom-jshint atom-material-syntax \
      atom-material-ui autocomplete-ruby file-icons highlight-selected language-ampscript \
      language-crontab language-gherkin linter linter-erb linter-htmlhint linter-js-yaml \
      linter-jscs linter-rubocop linter-ruby merge-conflicts pigments pretty-json rails-rspec rspec \
      toggle-packages atomic-emacs
  else
      echo "Skipping Atom Plugin Installation"
  fi
fi

# CLOSE UP SHOP ===============================================================

echo '-- your buffet has been served!'
set +u
exit 0
