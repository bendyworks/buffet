#!/usr/bin/env bash

set -u
echo '-- serving Bendyworks Buffet...'

# DOTFILE LINKING =============================================================

# absolute path to the Buffet directory
rel_path="$(dirname "$0")"
cd "$rel_path/.."
export BUFFET_DIRECTORY="$(pwd)"

function contains() {
  local n=$#
  local value=${!n}
  for ((i=1;i < $#;i++)) {
    if [ "${!i}" == "${value}" ]; then
      echo "y"
      return 0
    fi
  }
  echo "n"
  return 1
}

# sourcefiles and directories to ignore
IGNORE_FILES=("." ".." ".git")

# link every dotfile in dotfiles/ into the user's home directory
# if a dotfile exists with that name, add the ".unused" extension
for sourcefile in $BUFFET_DIRECTORY/dotfiles/{.*,*}; do
  filename="${sourcefile##*/}"

  # Ignore certain files
  if [ $(contains "${IGNORE_FILES[@]}" "$filename") == "y" ]; then
    continue;
  fi

  targetfile="$HOME/.$filename"

  [ ! -h "$targetfile" ] && mv "$targetfile" "$targetfile.unused" 2> /dev/null

  if [ -h "$targetfile" ] && [ -d "$targetfile" ]; then
    echo "removing symlink: $targetfile"
    rm $targetfile
  fi

  ln -fs "$sourcefile" "$targetfile"
done

# VIM SETUP ===================================================================

# set backup directories so that .swp files don't litter the workspace
vim_dir="$HOME/.vim"
mkdir -p "$vim_dir/backup"
mkdir -p "$vim_dir/swp"
mkdir -p "$vim_dir/undo"

# install vundle to ease installing Vim plugins
vundle_dir="$vim_dir/bundle"
vundle_path="$vundle_dir/Vundle.vim"
vundle_repo='https://github.com/VundleVim/Vundle.vim.git'

mkdir -p "$vundle_dir"
if [ ! -d "$vundle_path" ]; then
  echo '-- installing Vim plugins...'
  git clone "$vundle_repo" "$vundle_path"
  vim +PluginInstall +qall
fi

# Defaults to Yes
read -p "Install Atom Plugins (Y/n)? " answer
[ -z "$answer" ] && answer="Y"

if [ "$answer" != "${answer#[Yy]}" ] && hash apm 2>/dev/null; then
  echo '-- installing Atom plugins...'
  export BUFFET_APM_PACKAGES="\
    Sublime-Style-Column-Selection \
    atom-beautify \
    atom-bootstrap3 \
    atom-jshint \
    atom-material-syntax \
    atom-material-ui \
    atom-pair \
    atom-typescript \
    autocomplete-ruby \
    file-icons \
    highlight-selected \
    language-ampscript \
    language-crontab \
    language-gherkin \
    language-haml \
    language-rspec \
    linter \
    linter-erb \
    linter-htmlhint \
    linter-js-yaml \
    linter-jscs \
    linter-rubocop \
    linter-ruby \
    markdown-scroll-sync \
    merge-conflicts \
    pigments \
    pretty-json \
    rails-rspec \
    rails-transporter \
    rspec \
    ruby-test \
    script \
    toggle-packages \
    toggle-quotes"

  export INSTALLED_PACKAGES=$(apm list --installed --bare | sed -e 's/@.*//g')

  export PACKAGES_TO_INSTALL=$(comm -23 <(printf '%s\n' "${BUFFET_APM_PACKAGES[@]}" | tr " " "\n" | sort) <(printf '%s\n' "${INSTALLED_PACKAGES[@]}" | sort))

  echo "Installing ${PACKAGES_TO_INSTALL}"
  apm install

  # defaults to NO
  read -p "Install Vim Mode for Atom (y/N)? " answer
  if [[ $answer =~ ^[Yy]$ ]]; then
    apm install \
      vim-mode-plus \
      vim-surround
  fi

  # defaults to NO
  read -p "Install Emacs Keybindings for Atom (y/N)? " answer
  if [[ $answer =~ ^[Yy]$ ]]; then
    apm install atomic-emacs
  fi
fi

# CLOSE UP SHOP ===============================================================

echo '-- your buffet has been served!'
set +u
exit 0
